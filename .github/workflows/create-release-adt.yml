name: Release ADT Build

on:
  workflow_dispatch:
  workflow_run:
    workflows: [Build & Test Release]
    types: [completed]

permissions:
  contents: write

jobs:
  build:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: sudo apt-get install -y python3-paramiko python3-lxml

      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Restore
        run: dotnet restore

      - name: Build Packaging
        run: dotnet build Content.Packaging --configuration Release --no-restore /m

      - name: Package server
        run: dotnet run --project Content.Packaging server --platform linux-x64

      - name: Package client
        run: dotnet run --project Content.Packaging client --no-wipe-release

      - name: Prepare release folder
        run: |
          mkdir "release/${{ github.sha }}"
          mv release/*.zip "release/${{ github.sha }}"

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set variables
        id: vars
        run: |
          echo "release_date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "branch=${{ github.event.workflow_run.head_branch || github.ref_name }}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "auto-${{ steps.vars.outputs.release_date }}"
          name: "Release ${{ steps.vars.outputs.release_date }} from branch ${{ steps.vars.outputs.branch }}"
          body: |
            Автоматический билд от `${{ steps.vars.outputs.release_date }}`  
            Ветка: `${{ steps.vars.outputs.branch}`  
            Коммит: `${{ github.sha }}`
          files: release/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
